<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Congruence Lab (Offline)</title>
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg: #f1f5f9;
            --text: #1e293b;
            --white: #ffffff;
            --border: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --error-bg: #fee2e2;
            --error-text: #991b1b;
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 2rem; }
        
        /* --- 2. LAYOUT UTILITIES --- */
        .hidden { display: none !important; }
        .container { max-width: 1024px; margin: 0 auto; padding: 0 1rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }

        /* --- 3. COMPONENT STYLES --- */
        /* Header */
        header { background: var(--primary); color: var(--white); padding: 1rem 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; }
        .nav { background: var(--primary-dark); padding: 0.25rem; border-radius: 0.5rem; display: flex; gap: 0.25rem; }
        .nav-btn { background: transparent; color: #c7d2fe; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .nav-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav-btn:hover:not(.active) { color: var(--white); }

        /* Cards & Canvas */
        .card { background: var(--white); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .canvas-container { background: #f8fafc; border: 1px solid var(--border); border-radius: 0.5rem; height: 260px; width: 100%; overflow: hidden; position: relative; }
        svg { width: 100%; height: 100%; display: block; }

        /* Buttons & Badges */
        button { font-family: inherit; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.85rem; font-weight: bold; display: inline-block; }
        .badge-success { background: var(--success-bg); color: var(--success-text); }
        .badge-error { background: var(--error-bg); color: var(--error-text); }
        .badge-neutral { background: #e2e8f0; color: #475569; }

        .btn-action { background: var(--primary); color: var(--white); padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: background 0.2s; }
        .btn-action:hover { background: var(--primary-dark); }
        
        /* Explore Mode Specifics */
        .topic-btn { width: 100%; text-align: left; padding: 1rem; margin-bottom: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--white); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; transition: all 0.2s; }
        .topic-btn:hover { border-color: #a5b4fc; }
        .topic-btn.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }

        /* Quiz Mode Specifics */
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .option-btn { width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--white); font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { border-color: #a5b4fc; background: #eef2ff; }
        .option-btn.correct { background: var(--success-bg); border-color: var(--success-text); color: var(--success-text); }
        .option-btn.incorrect { opacity: 0.5; border-color: var(--border); }

        /* Proof Mode Specifics */
        .proof-toggle { padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.9rem; font-weight: bold; cursor: pointer; border: none; margin-right: 0.5rem; }
        .proof-toggle.active { background: var(--primary); color: white; }
        .proof-toggle.inactive { background: #e2e8f0; color: #475569; }

        .bank-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 1rem; }
        .bank-item { padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #475569; background: #334155; color: white; cursor: pointer; font-size: 0.85rem; text-align: center; }
        .bank-item.selected { background: var(--primary); border-color: #a5b4fc; box-shadow: 0 0 0 2px white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 0.75rem; background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 1rem 0.75rem; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        td:first-child { border-right: 1px solid #f1f5f9; width: 50%; font-family: 'Times New Roman', serif; font-size: 1.1rem; }

        .slot-btn { width: 100%; padding: 0.5rem; border: 2px dashed #cbd5e1; border-radius: 0.25rem; background: #f8fafc; color: #94a3b8; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .slot-btn.filled { background: #eef2ff; border-color: #c7d2fe; color: var(--primary); border-style: solid; }
        .slot-btn.success { background: #dcfce7; border-color: #86efac; color: #166534; border-style: solid; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="container header-inner">
            <div class="logo">
                <span>üìê</span> The Congruence Lab
            </div>
            <nav class="nav">
                <button onclick="switchTab('explore')" id="btn-explore" class="nav-btn active">
                    <span>üìñ</span> Explore
                </button>
                <button onclick="switchTab('practice')" id="btn-practice" class="nav-btn">
                    <span>‚úèÔ∏è</span> Apply
                </button>
                <button onclick="switchTab('proof')" id="btn-proof" class="nav-btn">
                    <span>üèÜ</span> Prove
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="margin-top: 2rem;">
        
        <!-- Explore Section -->
        <div id="section-explore" class="fade-in">
            <div class="grid-3">
                <!-- Topics List -->
                <div id="explore-menu">
                    <!-- Populated by JS -->
                </div>

                <!-- Topic Detail -->
                <div class="card" id="explore-display">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Practice Section -->
        <div id="section-practice" class="hidden">
            <div style="max-width: 800px; margin: 0 auto;" id="quiz-container">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Proof Section -->
        <div id="section-proof" class="hidden">
            <div class="grid-2">
                <!-- Left: Diagram & Bank -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div class="card">
                        <div class="mb-4">
                            <button onclick="loadProof('SAA')" id="proof-btn-saa" class="proof-toggle active">SAA Proof</button>
                            <button onclick="loadProof('HL')" id="proof-btn-hl" class="proof-toggle inactive">HL Proof</button>
                        </div>
                        <h2 style="margin: 0 0 0.5rem 0;" id="proof-title">Proof Title</h2>
                        <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.9rem; color: #334155; margin-bottom: 1rem; font-family: monospace;">
                            <div class="mb-2"><strong>Given:</strong> <span id="proof-given">...</span></div>
                            <div><strong>Prove:</strong> <span id="proof-goal">...</span></div>
                        </div>
                        <div id="proof-canvas-container" class="canvas-container"></div>
                    </div>

                    <!-- Reason Bank -->
                    <div class="card" style="background: #1e293b; color: white; border: none;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üß†</span> Reason Bank
                        </h3>
                        <p style="font-size: 0.9rem; color: #94a3b8; margin: 0.5rem 0;">Select a reason, then tap "???" in the table.</p>
                        <div class="bank-grid" id="proof-bank">
                            <!-- Bank items -->
                        </div>
                    </div>
                </div>

                <!-- Right: Table -->
                <div class="card" style="display: flex; flex-direction: column;">
                    <div style="font-weight: bold; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        Two-Column Proof
                    </div>
                    <div style="flex-grow: 1;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Statement</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="proof-steps">
                                <!-- Steps -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;" id="proof-action-area">
                        <button onclick="validateProof()" class="btn-action">Validate Proof</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- 1. SVG Drawing Logic ---
        function generateTriangleSVG(type, marks, showLabels = true) {
            const p1 = { x: 50, y: 150 };
            const p2 = { x: 250, y: 150 };
            const p3 = { x: 100, y: 50 };
            
            function getSideMarks(start, end, count) {
                if (!count) return '';
                const midX = (start.x + end.x) / 2;
                const midY = (start.y + end.y) / 2;
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const len = Math.sqrt(dx * dx + dy * dy);
                if (len === 0) return ''; 
                const px = -dy / len;
                const py = dx / len;
                let svg = '';
                const spacing = 6;
                const size = 8;
                for (let i = 0; i < count; i++) {
                    const offset = (i - (count - 1) / 2) * spacing;
                    const x1 = midX + px * size + (dx/len)*offset;
                    const y1 = midY + py * size + (dy/len)*offset;
                    const x2 = midX - px * size + (dx/len)*offset;
                    const y2 = midY - py * size + (dy/len)*offset;
                    svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#EF4444" stroke-width="2" />`;
                }
                return svg;
            }

            function getAngleMarks(vertex, pA, pB, count, isRight = false) {
                if (!count && !isRight) return '';
                const angleA = Math.atan2(pA.y - vertex.y, pA.x - vertex.x);
                const angleB = Math.atan2(pB.y - vertex.y, pB.x - vertex.x);
                if (isRight) {
                    const size = 15;
                    const vx = vertex.x;
                    const vy = vertex.y;
                    const signX = pA.x > vx ? 1 : -1;
                    return `<path d="M ${vx} ${vy} L ${vx + size*signX} ${vy} L ${vx + size*signX} ${vy - size} L ${vx} ${vy - size}" fill="none" stroke="#EF4444" stroke-width="2"/>`;
                }
                let svg = '';
                const radius = 25;
                for(let i=0; i<count; i++) {
                    const r = radius + (i * 5);
                    const x1 = vertex.x + r * Math.cos(angleA);
                    const y1 = vertex.y + r * Math.sin(angleA);
                    const x2 = vertex.x + r * Math.cos(angleB);
                    const y2 = vertex.y + r * Math.sin(angleB);
                    const sweep = angleB > angleA ? 1 : 0;
                    svg += `<path d="M ${x1} ${y1} A ${r} ${r} 0 0 ${sweep} ${x2} ${y2}" fill="none" stroke="#EF4444" stroke-width="2" />`;
                }
                return svg;
            }

            function getTriangleGroup(offsetX, offsetY, rotation, labelPrefix) {
                const safeMarks = marks || {};
                const s1 = getSideMarks(p1, p3, safeMarks.s1);
                const s2 = getSideMarks(p3, p2, safeMarks.s2);
                const s3 = getSideMarks(p1, p2, safeMarks.s3);
                const a1 = getAngleMarks(p1, p3, p2, safeMarks.a1);
                const a2 = getAngleMarks(p2, p1, p3, safeMarks.a2);
                const a3 = getAngleMarks(p3, p1, p2, safeMarks.a3, safeMarks.isRight);

                let labels = '';
                if (showLabels) {
                    labels = `
                        <text x="${p1.x-15}" y="${p1.y+10}" font-weight="bold" font-size="18" font-family="sans-serif">${labelPrefix}1</text>
                        <text x="${p2.x+10}" y="${p2.y+10}" font-weight="bold" font-size="18" font-family="sans-serif">${labelPrefix}2</text>
                        <text x="${p3.x-5}" y="${p3.y-10}" font-weight="bold" font-size="18" font-family="sans-serif">${labelPrefix}3</text>
                    `;
                }
                return `<g transform="translate(${offsetX}, ${offsetY}) rotate(${rotation}, 150, 100)">
                        <polygon points="${p1.x},${p1.y} ${p2.x},${p2.y} ${p3.x},${p3.y}" fill="white" stroke="black" stroke-width="3" stroke-linejoin="round" />
                        ${s1}${s2}${s3}${a1}${a2}${a3}${labels}
                    </g>`;
            }

            const t1 = getTriangleGroup(0, 20, 0, 'A');
            const t2 = getTriangleGroup(300, 20, type === 'REFLEXIVE' ? 0 : 180, 'B');
            return `<svg viewBox="0 0 600 250">${t1}${t2}</svg>`;
        }

        // --- 2. Data ---
        const exploreData = {
            SSS: { title: "Side-Side-Side (SSS)", marks: { s1: 1, s2: 2, s3: 3 }, valid: true, description: "If three sides of one triangle are congruent to three sides of another triangle, then the triangles are congruent.", conjecture: "Conjecture: We only need 3 pairs of matching sides to prove congruence.", minParts: "3 Sides" },
            SAS: { title: "Side-Angle-Side (SAS)", marks: { s1: 1, a1: 1, s3: 2 }, valid: true, description: "If two sides and the included angle of one triangle are congruent to two sides and the included angle of another triangle, then the triangles are congruent.", conjecture: "Conjecture: The angle MUST be between the two sides (included).", minParts: "2 Sides + 1 Included Angle" },
            ASA: { title: "Angle-Side-Angle (ASA)", marks: { a1: 1, s1: 1, a3: 2 }, valid: true, description: "If two angles and the included side of one triangle are congruent to two angles and the included side of another triangle, then the triangles are congruent.", conjecture: "Conjecture: The side connects the two angles. The intersection of the angle rays determines the third vertex.", minParts: "2 Angles + 1 Included Side" },
            AAS: { title: "Angle-Angle-Side (AAS/SAA)", marks: { a1: 1, a2: 2, s1: 1 }, valid: true, description: "If two angles and a non-included side of one triangle are congruent to corresponding parts of another triangle, then the triangles are congruent.", conjecture: "Logic: If two angles are known, the third is known (Sum Theorem).", minParts: "2 Angles + 1 Non-included Side" },
            HL: { title: "Hypotenuse-Leg (HL)", marks: { s1: 1, s2: 2, isRight: true }, valid: true, description: "If the hypotenuse and a leg of a right triangle are congruent to the hypotenuse and a leg of another right triangle, then the triangles are congruent.", conjecture: "Special Case: Right triangles only. Pythagorean theorem fixes the third side.", minParts: "Hyp + Leg + Right Angle" },
            AAA: { title: "Angle-Angle-Angle (AAA)", marks: { a1: 1, a2: 2, a3: 3 }, valid: false, description: "DOES NOT PROVE CONGRUENCE. It only proves similarity.", conjecture: "Failure: Size is not fixed. One triangle can be a scaled version of the other.", minParts: "Insufficient" },
            SSA: { title: "Side-Side-Angle (SSA)", marks: { s1: 1, s2: 2, a2: 1 }, valid: false, description: "DOES NOT PROVE CONGRUENCE.", conjecture: "Failure: 'The Swinging Gate'. The second side can swing to hit the base in two spots.", minParts: "Insufficient" }
        };

        const quizQuestions = [
            { id: 1, marks: { s1: 1, s2: 2, s3: 3 }, answer: "SSS", options: ["SSS", "SAS", "ASA", "Not Possible"], context: "Two triangular roof trusses have all three corresponding beams equal in length." },
            { id: 2, marks: { s1: 1, a1: 1, s3: 2 }, answer: "SAS", options: ["SSS", "SAS", "SSA", "ASA"], context: "A surveyor measures two sides of a plot and the angle between them." },
            { id: 3, marks: { a1: 1, a2: 2, a3: 3 }, answer: "Not Possible", options: ["AAA", "ASA", "AAS", "Not Possible"], context: "Two triangles have identical angles but we don't know the side lengths." },
            { id: 4, marks: { a1: 1, a2: 2, s1: 1 }, answer: "AAS", options: ["ASA", "AAS", "SAS", "HL"], context: "We know two angles and a side that is NOT between them." },
            { id: 5, marks: { s1: 1, s2: 2, isRight: true }, answer: "HL", options: ["SAS", "SSA", "HL", "Not Possible"], context: "Two right triangles have congruent hypotenuses and one pair of congruent legs." }
        ];

        const proofData = {
            SAA: {
                title: "Prove the SAA (AAS) Theorem",
                given: "‚à†A ‚âÖ ‚à†D, ‚à†B ‚âÖ ‚à†E, Side AC ‚âÖ DF",
                goal: "‚ñ≥ABC ‚âÖ ‚ñ≥DEF",
                diagramMarks: { a1: 1, a3: 2, s3: 1 },
                steps: [
                    { id: 1, statement: "‚à†A ‚âÖ ‚à†D, ‚à†B ‚âÖ ‚à†E", reason: "Given" },
                    { id: 2, statement: "‚à†C ‚âÖ ‚à†F", reason: "???" },
                    { id: 3, statement: "AC ‚âÖ DF", reason: "Given" },
                    { id: 4, statement: "‚ñ≥ABC ‚âÖ ‚ñ≥DEF", reason: "???" }
                ],
                bank: [
                    { id: 'b1', text: "Third Angle Theorem", correctSlot: 2 },
                    { id: 'b2', text: "ASA Postulate", correctSlot: 4 },
                    { id: 'b3', text: "SSS Postulate", correctSlot: null },
                    { id: 'b4', text: "Reflexive Property", correctSlot: null }
                ]
            },
            HL: {
                title: "Prove the Hypotenuse-Leg (HL) Theorem",
                given: "Right ‚ñ≥ABC & ‚ñ≥DEF, AC ‚âÖ DF (Hyp), AB ‚âÖ DE (Leg)",
                goal: "‚ñ≥ABC ‚âÖ ‚ñ≥DEF",
                diagramMarks: { s1: 1, s3: 2, isRight: true },
                steps: [
                    { id: 1, statement: "AC ‚âÖ DF, AB ‚âÖ DE", reason: "Given" },
                    { id: 2, statement: "AB¬≤ + BC¬≤ = AC¬≤", reason: "???" },
                    { id: 3, statement: "BC ‚âÖ EF", reason: "Subtraction Prop. of Equality" },
                    { id: 4, statement: "‚ñ≥ABC ‚âÖ ‚ñ≥DEF", reason: "???" }
                ],
                bank: [
                    { id: 'b1', text: "Pythagorean Theorem", correctSlot: 2 },
                    { id: 'b2', text: "SSS Postulate", correctSlot: 4 },
                    { id: 'b3', text: "Vertical Angles", correctSlot: null },
                    { id: 'b4', text: "SAS Postulate", correctSlot: null }
                ]
            }
        };

        // --- 3. App State & Logic ---
        let currentTab = 'explore';
        let currentExploreTopic = 'SSS';
        let quizIndex = 0;
        let quizScore = 0;
        let quizAnswered = false;
        let currentProofId = 'SAA';
        let proofSlots = {}; 
        let selectedBankItem = null;
        let proofComplete = false;

        function switchTab(tab) {
            // Hide all sections
            document.getElementById('section-explore').classList.add('hidden');
            document.getElementById('section-explore').classList.remove('fade-in');
            document.getElementById('section-practice').classList.add('hidden');
            document.getElementById('section-practice').classList.remove('fade-in');
            document.getElementById('section-proof').classList.add('hidden');
            document.getElementById('section-proof').classList.remove('fade-in');
            
            // Reset nav buttons
            ['explore', 'practice', 'proof'].forEach(t => {
                document.getElementById('btn-'+t).className = 'nav-btn';
            });

            // Show target
            const target = document.getElementById('section-'+tab);
            target.classList.remove('hidden');
            target.classList.add('fade-in'); // Add animation class on switch
            document.getElementById('btn-'+tab).className = 'nav-btn active';

            currentTab = tab;
            if(tab === 'explore') renderExplore();
            if(tab === 'practice') {
                if(quizIndex === 0 && quizScore === 0 && !quizAnswered) renderQuiz();
            }
            if(tab === 'proof') loadProof(currentProofId);
        }

        function renderExplore() {
            const data = exploreData[currentExploreTopic];
            
            // Render Menu
            const menuHtml = Object.keys(exploreData).map(key => {
                const item = exploreData[key];
                const activeClass = key === currentExploreTopic ? 'active' : '';
                const icon = item.valid ? '<span style="color:#166534">‚úì</span>' : '<span style="color:#991b1b">‚úó</span>';
                return `<button onclick="setExploreTopic('${key}')" class="topic-btn ${activeClass}">
                            <span>${key}</span> ${icon}
                        </button>`;
            }).join('');
            document.getElementById('explore-menu').innerHTML = menuHtml;

            // Render Display
            const badgeClass = data.valid ? 'badge-success' : 'badge-error';
            const badgeText = data.valid ? "Valid Method" : "Insufficient";
            
            document.getElementById('explore-display').innerHTML = `
                <div class="flex-between mb-4">
                    <h2 style="margin:0; font-size: 1.5rem;">${data.title}</h2>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                </div>
                <div class="canvas-container">
                    ${generateTriangleSVG(currentExploreTopic, data.marks)}
                </div>
                <div class="mt-4" style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--primary);">
                    <div style="font-weight: bold; color: var(--primary); font-size: 0.85rem; text-transform: uppercase;">Definition</div>
                    <p style="margin: 0.5rem 0;">${data.description}</p>
                </div>
                <div class="mt-4" style="background: #fffbeb; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #f59e0b;">
                    <div style="font-weight: bold; color: #b45309; font-size: 0.85rem; text-transform: uppercase;">Geometric Conjecture</div>
                    <p style="margin: 0.5rem 0; font-style: italic;">"${data.conjecture}"</p>
                </div>
            `;
        }

        function setExploreTopic(topic) {
            currentExploreTopic = topic;
            renderExplore();
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            if (quizIndex >= quizQuestions.length) {
                container.innerHTML = `
                    <div class="card text-center" style="padding: 3rem 1rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèÜ</div>
                        <h2>Quiz Complete!</h2>
                        <p style="font-size: 1.25rem; color: #64748b;">You scored ${quizScore} out of ${quizQuestions.length}</p>
                        <button onclick="restartQuiz()" class="btn-action" style="margin-top: 1rem;">
                            <span>‚Ü∫</span> Try Again
                        </button>
                    </div>
                `;
                return;
            }

            const q = quizQuestions[quizIndex];
            const optionsHtml = q.options.map(opt => {
                let className = "option-btn";
                let disabled = "";
                if (quizAnswered) {
                    disabled = "disabled";
                    if (opt === q.answer) className += " correct";
                    else className += " incorrect";
                }
                return `<button onclick="handleQuizAnswer('${opt}')" ${disabled} class="${className}">${opt}</button>`;
            }).join('');

            let feedbackHtml = '';
            if (quizAnswered) {
                const isCorrect = window.lastQuizResult === true;
                const bg = isCorrect ? 'var(--success-bg)' : 'var(--error-bg)';
                const color = isCorrect ? 'var(--success-text)' : 'var(--error-text)';
                const msg = isCorrect ? "Correct! Well done." : `Incorrect. The answer was ${q.answer}.`;
                feedbackHtml = `
                    <div class="fade-in" style="margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; background: ${bg}; color: ${color}; text-align: center;">
                        <p style="font-weight: bold; margin: 0 0 0.5rem 0;">${msg}</p>
                        <button onclick="nextQuestion()" class="btn-action" style="background: #1e293b; font-size: 0.9rem;">
                            Next Question <span>‚Üí</span>
                        </button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="card fade-in">
                    <div class="flex-between mb-4" style="border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        <span style="font-weight: bold; color: var(--primary);">Problem ${quizIndex + 1} / ${quizQuestions.length}</span>
                        <span class="badge badge-neutral">Score: ${quizScore}</span>
                    </div>
                    <p style="font-size: 1.1rem; font-style: italic; color: #334155; margin-bottom: 1.5rem;">"${q.context}"</p>
                    <div class="canvas-container mb-4">${generateTriangleSVG(q.answer, q.marks)}</div>
                    <div style="text-align: center; margin: 1.5rem 0 1rem 0; font-weight: bold;">Identify the Theorem:</div>
                    <div class="option-grid">${optionsHtml}</div>
                    ${feedbackHtml}
                </div>
            `;
        }

        function handleQuizAnswer(ans) {
            if(quizAnswered) return;
            const correct = ans === quizQuestions[quizIndex].answer;
            if(correct) quizScore++;
            quizAnswered = true;
            window.lastQuizResult = correct;
            renderQuiz();
        }

        function nextQuestion() {
            quizIndex++;
            quizAnswered = false;
            renderQuiz();
        }

        function restartQuiz() {
            quizIndex = 0;
            quizScore = 0;
            quizAnswered = false;
            renderQuiz();
        }

        function loadProof(pid) {
            currentProofId = pid;
            proofSlots = {};
            selectedBankItem = null;
            proofComplete = false;
            
            // Toggles
            const btnSaa = document.getElementById('proof-btn-saa');
            const btnHl = document.getElementById('proof-btn-hl');
            if(pid === 'SAA') {
                btnSaa.className = 'proof-toggle active';
                btnHl.className = 'proof-toggle inactive';
            } else {
                btnSaa.className = 'proof-toggle inactive';
                btnHl.className = 'proof-toggle active';
            }

            const data = proofData[pid];
            document.getElementById('proof-title').innerText = data.title;
            document.getElementById('proof-given').innerText = data.given;
            document.getElementById('proof-goal').innerText = data.goal;
            document.getElementById('proof-canvas-container').innerHTML = generateTriangleSVG(null, data.diagramMarks);
            renderProofUI();
        }

        function renderProofUI() {
            const data = proofData[currentProofId];
            
            // Bank
            document.getElementById('proof-bank').innerHTML = data.bank.map(item => {
                const isSelected = selectedBankItem && selectedBankItem.id === item.id;
                const cls = isSelected ? 'bank-item selected' : 'bank-item';
                return `<button onclick="selectBankItem('${item.id}')" ${proofComplete?'disabled':''} class="${cls}">${item.text}</button>`;
            }).join('');

            // Steps
            document.getElementById('proof-steps').innerHTML = data.steps.map(step => {
                let reasonHtml;
                if(step.reason !== "???") {
                    reasonHtml = `<span style="font-style: italic; color: #64748b;">${step.reason}</span>`;
                } else {
                    const filled = proofSlots[step.id];
                    let cls = "slot-btn";
                    if(proofComplete) cls += " success";
                    else if(filled) cls += " filled";
                    
                    reasonHtml = `<button onclick="fillSlot(${step.id})" ${proofComplete?'disabled':''} class="${cls}">
                        ${filled ? filled.text : "Select Reason..."}
                    </button>`;
                }
                return `<tr><td>${step.statement}</td><td>${reasonHtml}</td></tr>`;
            }).join('');

            const area = document.getElementById('proof-action-area');
            if(proofComplete) {
                area.innerHTML = `<span style="color: var(--success-text); font-weight: bold; display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;"><span>‚úì</span> Proof Validated!</span>`;
            } else {
                area.innerHTML = `<button onclick="validateProof()" class="btn-action">Validate Proof</button>`;
            }
        }

        function selectBankItem(id) {
            selectedBankItem = proofData[currentProofId].bank.find(b => b.id === id);
            renderProofUI();
        }

        function fillSlot(sid) {
            if(proofSlots[sid]) delete proofSlots[sid];
            else if(selectedBankItem) {
                proofSlots[sid] = selectedBankItem;
                selectedBankItem = null;
            }
            renderProofUI();
        }

        function validateProof() {
            const data = proofData[currentProofId];
            let correct = true;
            data.steps.forEach(s => {
                if(s.reason === "???") {
                    const filled = proofSlots[s.id];
                    if(!filled || filled.correctSlot !== s.id) correct = false;
                }
            });
            if(correct) {
                proofComplete = true;
                renderProofUI();
            } else {
                alert("Incorrect logic. Please review your reasons.");
            }
        }

        // Init
        window.onload = function() {
            switchTab('explore');
        };
    </script>
</body>
</html>
